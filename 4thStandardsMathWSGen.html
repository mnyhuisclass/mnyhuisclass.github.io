<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 4 Math Worksheet Generator V3</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Bangers&family=Press+Start+2P&family=Patrick+Hand&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        space: { 100: '#e0e7ff', 800: '#1e1b4b', 900: '#0f172a' },
                        camp: { 100: '#fef3c7', 800: '#3f6212', 900: '#14532d' },
                        hero: { 100: '#fee2e2', 500: '#ef4444', 900: '#1e3a8a' },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        hero: ['Bangers', 'cursive'],
                        space: ['"Press Start 2P"', 'cursive'],
                        camp: ['"Patrick Hand"', 'cursive'],
                        slab: ['"Roboto Slab"', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles & Transitions */
        body { transition: background-color 0.3s, color 0.3s; }
        .worksheet-container { transition: all 0.3s ease-in-out; }
        
        /* Theme: Space */
        body.theme-space { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .theme-space .panel { background-color: #1e293b; border: 1px solid #334155; }
        .theme-space .sheet-paper { background-color: #f8fafc; color: #0f172a; border: 4px solid #3b82f6; }
        .theme-space .accent-text { color: #60a5fa; }
        .theme-space .accent-bg { background-color: #3b82f6; }
        .theme-space .btn-primary { background-color: #3b82f6; color: white; }
        .theme-space .sheet-header { font-family: 'Press Start 2P', cursive; color: #1e3a8a; }

        /* Theme: Camp */
        body.theme-camp { background-color: #3f4d36; color: #fefce8; font-family: 'Roboto Slab', serif; background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h20v20H0V0zm10 17l-4-4h8l-4 4zm-4-4l4-4 4 4H6z' fill='%232f3b26' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E"); }
        .theme-camp .panel { background-color: #fefce8; color: #3f6212; border: 2px dashed #3f6212; }
        .theme-camp .sheet-paper { background-color: #fffbeb; color: #3f6212; border: 4px double #3f6212; }
        .theme-camp .accent-text { color: #d97706; }
        .theme-camp .accent-bg { background-color: #65a30d; }
        .theme-camp .btn-primary { background-color: #65a30d; color: white; }
        .theme-camp .sheet-header { font-family: 'Patrick Hand', cursive; font-size: 1.5em; letter-spacing: 2px; }

        /* Theme: Superhero */
        body.theme-hero { background-color: #ffffff; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; font-family: 'Inter', sans-serif; }
        .theme-hero .panel { background-color: #fff; border: 3px solid #000; box-shadow: 8px 8px 0px #000; }
        .theme-hero .sheet-paper { background-color: white; border: 4px solid #000; }
        .theme-hero .accent-text { color: #ef4444; font-family: 'Bangers', cursive; letter-spacing: 1px; }
        .theme-hero .accent-bg { background-color: #ef4444; }
        .theme-hero .btn-primary { background-color: #2563eb; color: white; border: 2px solid black; box-shadow: 4px 4px 0 black; transition: transform 0.1s; }
        .theme-hero .btn-primary:active { transform: translate(4px, 4px); box-shadow: 0 0 0 black; }
        .theme-hero .sheet-header { font-family: 'Bangers', cursive; color: #dc2626; text-transform: uppercase; font-size: 2em; transform: rotate(-1deg); }

        /* Theme: Normal (Default) */
        body.theme-normal { background-color: #f3f4f6; color: #1f2937; }
        .theme-normal .panel { background-color: white; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .theme-normal .sheet-paper { background-color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; }
        .theme-normal .accent-text { color: #4b5563; }
        .theme-normal .accent-bg { background-color: #374151; }
        .theme-normal .btn-primary { background-color: #111827; color: white; }
        .theme-normal .sheet-header { font-family: 'Inter', sans-serif; font-weight: 700; color: #111827; }

        /* Math Styling */
        .problem-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; }
        .long-division { border-top: 2px solid currentColor; border-left: 2px solid currentColor; padding-left: 0.5rem; display: inline-block; margin-left: 0.5rem; }
        .fraction { display: inline-block; vertical-align: middle; text-align: center; font-size: 0.9em; }
        .fraction-top { border-bottom: 2px solid currentColor; display: block; padding: 0 0.2rem; }
        .fraction-bottom { display: block; padding: 0 0.2rem; }
        .mixed-fraction { display: flex; align-items: center; gap: 4px; }
        
        /* Print Styles - Crucial for clean output */
        @media print {
            body { background: white !important; color: black !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .sheet-paper { 
                box-shadow: none !important; 
                border: 2px solid #000 !important; 
                width: 100% !important; 
                max-width: 100% !important; 
                margin: 0 !important;
                padding: 0 !important;
                page-break-after: always;
            }
            .problem-container { page-break-inside: avoid; }
            /* Force themes to look good in B&W but keep flavor */
            .theme-space .sheet-header, .theme-camp .sheet-header, .theme-hero .sheet-header { color: black !important; }
        }
    </style>
</head>
<body class="theme-normal min-h-screen flex flex-col items-center py-8 px-4">

    <!-- Config Panel (No Print) -->
    <div class="no-print w-full max-w-4xl mb-8 space-y-6">
        <div class="panel p-6 rounded-xl flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold mb-1"><i class="fas fa-shapes mr-2"></i>Grade 4 Math Gen</h1>
                <p class="opacity-75 text-sm">Select standard & theme to generate.</p>
            </div>
            
            <div class="flex gap-4 items-center">
                <!-- Theme Select -->
                <div class="flex bg-gray-200/50 p-1 rounded-lg">
                    <button onclick="setTheme('normal')" class="p-2 rounded hover:bg-white/50 transition" title="Professional"><i class="fas fa-briefcase"></i></button>
                    <button onclick="setTheme('space')" class="p-2 rounded hover:bg-white/50 transition" title="Space"><i class="fas fa-rocket"></i></button>
                    <button onclick="setTheme('camp')" class="p-2 rounded hover:bg-white/50 transition" title="Camp"><i class="fas fa-tree"></i></button>
                    <button onclick="setTheme('hero')" class="p-2 rounded hover:bg-white/50 transition" title="Superhero"><i class="fas fa-mask"></i></button>
                </div>

                <!-- Print Btn -->
                <button onclick="window.print()" class="btn-primary px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>

        <div class="panel p-6 rounded-xl grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Standard Selector -->
            <div class="col-span-2">
                <label class="block text-sm font-bold mb-2 opacity-75">Indiana Academic Standard (Grade 4)</label>
                <select id="standardSelect" class="w-full p-3 rounded border border-gray-300 bg-white/90 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <optgroup label="Computation (Whole Numbers)">
                        <option value="4.C.1">4.C.1 - Add/Subtract Multi-Digit Whole Numbers</option>
                        <option value="4.C.2">4.C.2 - Multiply Whole Numbers (2x2 or 4x1)</option>
                        <option value="4.C.3">4.C.3 - Divide Whole Numbers (4-digit by 1-digit)</option>
                    </optgroup>
                    <optgroup label="Computation (Fractions)">
                        <option value="4.CA.6">4.CA.6 - Add/Subtract Fractions (Visual)</option>
                        <option value="4.CA.7">4.CA.7 - Add/Subtract Mixed Numbers</option>
                        <option value="4.CA.8">4.CA.8 - Fraction Word Problems</option>
                    </optgroup>
                    <optgroup label="Number Sense">
                        <option value="4.NS.1">4.NS.1 - Place Value & Rounding</option>
                        <option value="4.NS.3">4.NS.3 - Express Fractions (Decimals/Mixed)</option>
                        <option value="4.NS.5">4.NS.5 - Decimal/Fraction Notation (Tenths/Hundredths)</option>
                        <option value="4.NS.6">4.NS.6 - Compare Decimals to Hundredths</option>
                    </optgroup>
                    <optgroup label="Measurement">
                        <option value="4.M.1">4.M.1 - Measure Length (Ruler)</option>
                        <option value="4.M.2">4.M.2 - Unit Conversions</option>
                        <option value="4.M.3">4.M.3 - Measurement Word Problems</option>
                        <option value="4.M.4">4.M.4 - Area & Perimeter (Rectangles)</option>
                    </optgroup>
                    <optgroup label="Geometry & Data">
                        <option value="4.G.1">4.G.1 - Lines and Angles (Identify)</option>
                        <option value="4.G.4">4.G.4 - Lines of Symmetry</option>
                        <option value="4.DA.1">4.DA.1 - Data Analysis (Tables/Graphs)</option>
                        <option value="4.DA.2">4.DA.2 - Line Plots with Fractions</option>
                    </optgroup>
                </select>
            </div>
            
            <!-- Generate Action -->
            <div class="flex items-end">
                <button onclick="generateWorksheet()" class="w-full btn-primary py-3 rounded-lg font-bold text-lg hover:opacity-90 transition">
                    Generate New <i class="fas fa-magic ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Worksheet Paper -->
    <div id="worksheet" class="sheet-paper w-full max-w-[8.5in] min-h-[11in] bg-white p-10 relative mx-auto">
        
        <!-- Header Section -->
        <div class="flex justify-between items-end border-b-4 border-current pb-4 mb-8">
            <div class="w-2/3">
                <h1 id="sheetTitle" class="sheet-header text-3xl mb-2">Mathematics Worksheet</h1>
                <p id="sheetSubtitle" class="text-sm opacity-75 font-mono">Standard: 4.C.1</p>
            </div>
            <div class="w-1/3 text-right space-y-4">
                <div class="border-b-2 border-dashed border-gray-400 pb-1">
                    <span class="text-xs uppercase font-bold opacity-50 mr-2">Name:</span>
                    <span class="inline-block w-32"></span>
                </div>
                <div class="border-b-2 border-dashed border-gray-400 pb-1">
                    <span class="text-xs uppercase font-bold opacity-50 mr-2">Date:</span>
                    <span class="inline-block w-32"></span>
                </div>
            </div>
        </div>

        <!-- Flavor Text -->
        <div id="flavorText" class="mb-6 italic text-center opacity-80 text-sm">
            Solve the problems below. Show your work!
        </div>

        <!-- Problems Area -->
        <div id="problemsContainer" class="problem-grid text-lg">
            <!-- Problems injected via JS -->
        </div>

        <!-- Footer -->
        <div class="absolute bottom-4 left-0 w-full text-center text-xs opacity-40">
            Generated by Teacher Tools V3
        </div>
    </div>

    <script>
        // --- Configuration & Data ---
        const themeConfig = {
            normal: { title: "Mathematics Practice", flavor: "Solve the problems below carefully.", font: "sans" },
            space: { title: "Mission Log: Calculations", flavor: "Commander! Calculate the trajectory data below.", font: "space" },
            camp: { title: "Wilderness Math Trail", flavor: "Navigator, chart your path by solving these clues.", font: "camp" },
            hero: { title: "HERO TRAINING ACADEMY", flavor: "Defeat the villains by cracking the code!", font: "hero" }
        };

        const names = ["Liam", "Olivia", "Noah", "Emma", "Oliver", "Ava", "Elijah", "Charlotte", "Mateo", "Amelia"];
        const items = ["apples", "books", "miles", "stickers", "marbles", "dollars"];

        // --- Core Functions ---

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function setTheme(themeName) {
            document.body.className = `theme-${themeName} min-h-screen flex flex-col items-center py-8 px-4`;
            
            // Update Text on Worksheet based on Theme
            const config = themeConfig[themeName];
            document.getElementById('sheetTitle').innerText = config.title;
            document.getElementById('flavorText').innerText = config.flavor;
        }

        function generateWorksheet() {
            const standard = document.getElementById('standardSelect').value;
            const container = document.getElementById('problemsContainer');
            container.innerHTML = ''; // Clear previous
            
            // Update Subtitle
            const select = document.getElementById('standardSelect');
            const standardText = select.options[select.selectedIndex].text;
            document.getElementById('sheetSubtitle').innerText = standardText;

            // Generate 8-10 problems
            for (let i = 1; i <= 8; i++) {
                const problem = createProblem(standard, i);
                container.appendChild(problem);
            }
        }

        function createProblem(standard, index) {
            const div = document.createElement('div');
            div.className = 'problem-container p-4 break-inside-avoid';
            
            let content = '';

            // Basic routing
            switch(standard) {
                // Existing
                case '4.C.1': content = generateAddSub(index); break;
                case '4.C.2': content = generateMultiplication(index); break;
                case '4.C.3': content = generateDivision(index); break;
                case '4.NS.1': content = generatePlaceValue(index); break;
                case '4.NS.3': content = generateFractions(index); break;
                case '4.M.4': content = generateAreaPerimeter(index); break;
                case '4.G.1': content = generateGeometryLines(index); break;
                case '4.G.4': content = generateSymmetry(index); break;
                
                // New additions
                case '4.CA.6': content = generateVisualFractionMath(index); break;
                case '4.CA.7': content = generateMixedNumberMath(index); break;
                case '4.CA.8': content = generateFractionWordProblem(index); break;
                case '4.NS.5': content = generateDecimalNotation(index); break;
                case '4.NS.6': content = generateDecimalComparison(index); break;
                case '4.M.1': content = generateMeasurementRuler(index); break;
                case '4.M.2': content = generateUnitConversion(index); break;
                case '4.M.3': content = generateMeasurementWordProblem(index); break;
                case '4.DA.1': content = generateDataInterpretation(index); break;
                case '4.DA.2': content = generateLinePlot(index); break;
                
                default: content = `<p>Standard logic not yet implemented.</p>`;
            }

            div.innerHTML = `<span class="font-bold mr-2 text-gray-400">${index}.</span>` + content;
            return div;
        }

        // ============================
        // === GENERATOR LOGIC ===
        // ============================

        // --- Fraction Visuals (4.CA.6) ---
        function generateVisualFractionMath(idx) {
            const den = [4, 6, 8, 10, 12][getRandomInt(0, 4)];
            const num1 = getRandomInt(1, den - 1);
            const num2 = getRandomInt(1, den - num1); // Ensure sum <= den for simplicity or slightly over
            
            // Helper to make pie chart SVG
            const makePie = (n, d) => {
                let paths = '';
                const radius = 20;
                const center = 22;
                for (let i = 0; i < d; i++) {
                    const startAngle = (i * 360 / d) * Math.PI / 180;
                    const endAngle = ((i + 1) * 360 / d) * Math.PI / 180;
                    const x1 = center + radius * Math.cos(startAngle);
                    const y1 = center + radius * Math.sin(startAngle);
                    const x2 = center + radius * Math.cos(endAngle);
                    const y2 = center + radius * Math.sin(endAngle);
                    const filled = i < n ? 'fill="currentColor" opacity="0.6"' : 'fill="none"';
                    paths += `<path d="M${center},${center} L${x1},${y1} A${radius},${radius} 0 0,1 ${x2},${y2} Z" ${filled} stroke="currentColor" stroke-width="1" />`;
                }
                return `<svg width="44" height="44" class="inline-block align-middle">${paths}</svg>`;
            };

            return `
                <div class="text-base">
                    <div class="mb-2">Use the model to add:</div>
                    <div class="flex items-center gap-2 text-xl">
                        ${makePie(num1, den)} 
                        <span>+</span>
                        ${makePie(num2, den)}
                        <span>=</span>
                        <div class="w-12 h-12 border border-dashed border-gray-400 rounded-full"></div>
                    </div>
                    <div class="mt-2 text-sm font-mono">
                        ${num1}/${den} + ${num2}/${den} = ______
                    </div>
                </div>
            `;
        }

        // --- Mixed Numbers (4.CA.7) ---
        function generateMixedNumberMath(idx) {
            const den = [3, 4, 5, 8][getRandomInt(0, 3)];
            const w1 = getRandomInt(1, 5);
            const n1 = getRandomInt(1, den - 1);
            const w2 = getRandomInt(1, 4);
            const n2 = getRandomInt(1, den - 1);
            const isAdd = Math.random() > 0.5;

            // Ensure first number is larger if subtracting
            let val1 = w1 + n1/den;
            let val2 = w2 + n2/den;
            let firstStr, secondStr;

            if (!isAdd && val1 < val2) {
                 // Swap
                 firstStr = `<div class="mixed-fraction"><span>${w2}</span><div class="fraction"><span class="fraction-top">${n2}</span><span class="fraction-bottom">${den}</span></div></div>`;
                 secondStr = `<div class="mixed-fraction"><span>${w1}</span><div class="fraction"><span class="fraction-top">${n1}</span><span class="fraction-bottom">${den}</span></div></div>`;
            } else {
                 firstStr = `<div class="mixed-fraction"><span>${w1}</span><div class="fraction"><span class="fraction-top">${n1}</span><span class="fraction-bottom">${den}</span></div></div>`;
                 secondStr = `<div class="mixed-fraction"><span>${w2}</span><div class="fraction"><span class="fraction-top">${n2}</span><span class="fraction-bottom">${den}</span></div></div>`;
            }

            return `
                <div class="text-xl font-mono inline-block text-right">
                    <div class="flex justify-end mb-2">${firstStr}</div>
                    <div class="flex justify-end border-b-2 border-current mb-2 pb-1">
                        <span class="mr-3">${isAdd ? '+' : '-'}</span>
                        ${secondStr}
                    </div>
                    <div class="h-8"></div>
                </div>
            `;
        }

        // --- Fraction Word Problems (4.CA.8) ---
        function generateFractionWordProblem(idx) {
            const name = getRandomItem(names);
            const den = [4, 5, 6, 8, 10][getRandomInt(0, 4)];
            const n1 = getRandomInt(1, den-2);
            const n2 = getRandomInt(1, den - n1);
            
            const scenarios = [
                `ate <strong>${n1}/${den}</strong> of a pizza for lunch and <strong>${n2}/${den}</strong> for dinner. How much pizza did ${name} eat in total?`,
                `ran <strong>${n1}/${den}</strong> of a mile on Monday and <strong>${n2}/${den}</strong> of a mile on Tuesday. How many miles did ${name} run?`,
                `painted <strong>${n1}/${den}</strong> of a fence in the morning and <strong>${n2}/${den}</strong> in the afternoon. What fraction of the fence is painted?`
            ];
            
            return `
                <div class="text-base">
                    <p class="mb-4">${name} ${getRandomItem(scenarios)}</p>
                    <div class="border-b border-gray-300 w-full h-8"></div>
                </div>
            `;
        }

        // --- Decimal Notation (4.NS.5) ---
        function generateDecimalNotation(idx) {
            const type = Math.random();
            if (type < 0.33) {
                // Fraction to Decimal
                const n = getRandomInt(1, 99);
                const den = n < 10 ? 10 : 100;
                return `<div class="text-base">Write <strong>${n}/${den}</strong> as a decimal.<div class="mt-4 border-b border-gray-300 w-24"></div></div>`;
            } else if (type < 0.66) {
                // Decimal to Fraction
                const val = (getRandomInt(1, 99) / 100).toFixed(2);
                return `<div class="text-base">Write <strong>${val}</strong> as a fraction.<div class="mt-4 border-b border-gray-300 w-24"></div></div>`;
            } else {
                // Word form
                const n = getRandomInt(1, 9);
                return `<div class="text-base">Write <strong>0.${n}</strong> in word form.<div class="mt-4 border-b border-gray-300 w-full"></div></div>`;
            }
        }

        // --- Decimal Comparison (4.NS.6) ---
        function generateDecimalComparison(idx) {
            // Generate two close decimals
            let d1 = getRandomInt(10, 99);
            let d2 = getRandomInt(10, 99);
            // Ensure they aren't same often
            while(d1 === d2) d2 = getRandomInt(10, 99);
            
            const v1 = (d1/100).toFixed(2);
            const v2 = (d2/100).toFixed(2);

            return `
                <div class="text-base text-center">
                    Compare using < , > , or =
                    <div class="text-2xl font-mono mt-2 flex justify-center items-center gap-4">
                        <span>${v1}</span>
                        <div class="w-12 h-12 border-2 border-gray-400 rounded-lg bg-gray-50"></div>
                        <span>${v2}</span>
                    </div>
                </div>
            `;
        }

        // --- Measurement Ruler (4.M.1) ---
        function generateMeasurementRuler(idx) {
            // Random length in 8ths
            const eighths = getRandomInt(1, 24); // up to 3 inches
            const widthPct = (eighths / 32) * 100 * 3; // Approx scaling
            
            // Build ruler SVG ticks
            let ticks = '';
            for(let i=0; i<=32; i++) {
                let h = 10;
                if (i % 8 === 0) h = 25; // Inch
                else if (i % 4 === 0) h = 20; // Half
                else if (i % 2 === 0) h = 15; // Quarter
                
                const x = (i/32) * 300; // 300px width total
                ticks += `<line x1="${x}" y1="0" x2="${x}" y2="${h}" stroke="black" stroke-width="1"/>`;
                if(i%8===0 && i>0) ticks += `<text x="${x-4}" y="38" font-size="10">${i/8}</text>`;
            }

            return `
                <div>
                    <p class="mb-2 text-sm">Measure the length of the bar to the nearest 1/8 inch.</p>
                    <div class="mb-0 relative">
                        <!-- Object -->
                        <div class="bg-gray-400 h-4 mb-0 rounded-sm" style="width: ${(eighths/32)*300}px"></div>
                    </div>
                    <!-- Ruler -->
                    <svg width="310" height="45" class="border-t border-black mt-0">
                        <g transform="translate(0,0)">
                           ${ticks}
                        </g>
                    </svg>
                    <div class="mt-2 text-sm">Length: _______ in.</div>
                </div>
            `;
        }

        // --- Unit Conversion (4.M.2) ---
        function generateUnitConversion(idx) {
            const types = [
                { unit1: 'kg', unit2: 'g', factor: 1000 },
                { unit1: 'km', unit2: 'm', factor: 1000 },
                { unit1: 'lb', unit2: 'oz', factor: 16 },
                { unit1: 'ft', unit2: 'in', factor: 12 },
                { unit1: 'hr', unit2: 'min', factor: 60 }
            ];
            const t = getRandomItem(types);
            const val = getRandomInt(2, 9);
            
            return `
                <div class="text-base">
                    Complete the conversion table:
                    <table class="w-full mt-2 border-collapse border border-gray-400 text-sm text-center">
                        <tr class="bg-gray-100">
                            <th class="border border-gray-400 p-1">${t.unit1}</th>
                            <th class="border border-gray-400 p-1">${t.unit2}</th>
                        </tr>
                        <tr>
                            <td class="border border-gray-400 p-1">1</td>
                            <td class="border border-gray-400 p-1">${t.factor}</td>
                        </tr>
                        <tr>
                            <td class="border border-gray-400 p-1">${val}</td>
                            <td class="border border-gray-400 p-1 bg-white h-8"></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        // --- Measurement Word Problem (4.M.3) ---
        function generateMeasurementWordProblem(idx) {
            const name = getRandomItem(names);
            const type = getRandomInt(0, 2);
            let text = "";
            
            if (type === 0) { // Money
                const d1 = getRandomInt(5, 20);
                const d2 = getRandomInt(2, 10);
                text = `${name} had $${d1}. They bought a book for $${d2}. How much money do they have left?`;
            } else if (type === 1) { // Time
                const min = getRandomInt(15, 45);
                text = `${name} started homework at 4:00 PM. They worked for ${min} minutes. What time did they finish?`;
            } else { // Distance
                const m1 = getRandomInt(100, 800);
                const m2 = getRandomInt(50, 200);
                text = `${name} walked ${m1} meters to the park and then ${m2} meters to school. How far did they walk in total?`;
            }

            return `
                <div class="text-base">
                    <p class="mb-4">${text}</p>
                    <div class="border-b border-gray-300 w-full h-8"></div>
                </div>
            `;
        }

        // --- Line Plots (4.DA.2) ---
        function generateLinePlot(idx) {
            const data = [];
            const vals = ["1/4", "1/2", "3/4"];
            for(let k=0; k<6; k++) data.push(getRandomItem(vals));
            
            return `
                <div class="text-sm">
                    <p class="mb-2">Plot the following data on the line plot:</p>
                    <p class="font-mono text-xs bg-gray-100 p-1 mb-4 text-center tracking-widest">${data.join(", ")}</p>
                    
                    <div class="relative h-20 border-b-2 border-black mx-4 mt-8">
                        <div class="absolute bottom-0 left-0 w-full flex justify-between transform translate-y-6 text-xs font-mono">
                            <span>0</span>
                            <span>1/4</span>
                            <span>1/2</span>
                            <span>3/4</span>
                            <span>1</span>
                        </div>
                        <!-- Ticks -->
                        <div class="absolute bottom-0 left-0 h-2 w-0.5 bg-black"></div>
                        <div class="absolute bottom-0 left-1/4 h-2 w-0.5 bg-black"></div>
                        <div class="absolute bottom-0 left-1/2 h-2 w-0.5 bg-black"></div>
                        <div class="absolute bottom-0 left-3/4 h-2 w-0.5 bg-black"></div>
                        <div class="absolute bottom-0 right-0 h-2 w-0.5 bg-black"></div>
                    </div>
                </div>
            `;
        }

        // --- Data Interpretation (4.DA.1) ---
        function generateDataInterpretation(idx) {
            const item = getRandomItem(items);
            const v1 = getRandomInt(5, 15);
            const v2 = getRandomInt(5, 15);
            const v3 = getRandomInt(5, 15);
            
            return `
                <div class="text-base">
                    <p class="mb-2 text-sm text-center font-bold">Number of ${item} collected</p>
                    <table class="w-full text-sm mb-2 border border-black">
                        <tr><td class="p-1 border border-black">Class A</td><td class="p-1 border border-black">${v1}</td></tr>
                        <tr><td class="p-1 border border-black">Class B</td><td class="p-1 border border-black">${v2}</td></tr>
                        <tr><td class="p-1 border border-black">Class C</td><td class="p-1 border border-black">${v3}</td></tr>
                    </table>
                    <p class="text-sm">How many more ${item} did Class ${v1 > v2 ? 'A' : 'B'} collect than Class ${v1 > v2 ? 'B' : 'A'}?</p>
                     <div class="mt-2 border-b border-gray-300 w-16"></div>
                </div>
            `;
        }


        // --- Legacy Functions (Kept for compatibility) ---
        function generateAddSub(idx) {
            const isAdd = Math.random() > 0.5;
            const num1 = getRandomInt(10000, 99999);
            const num2 = getRandomInt(1000, 40000);
            return `<div class="inline-block text-right font-mono text-xl leading-tight"><div>${isAdd?num1:Math.max(num1,num2)}</div><div class="border-b-2 border-current mb-2"><span class="mr-2">${isAdd?'+':'-'}</span>${isAdd?num2:Math.min(num1,num2)}</div><div class="h-8"></div></div>`;
        }
        function generateMultiplication(idx) {
            const type = Math.random();
            let n1, n2;
            if (type > 0.5) { n1 = getRandomInt(11, 99); n2 = getRandomInt(11, 99); } else { n1 = getRandomInt(1000, 9999); n2 = getRandomInt(2, 9); }
            return `<div class="inline-block text-right font-mono text-xl leading-tight"><div>${n1}</div><div class="border-b-2 border-current mb-2"><span class="mr-2">×</span>${n2}</div><div class="h-8"></div></div>`;
        }
        function generateDivision(idx) {
            const divisor = getRandomInt(2, 9);
            const quotient = getRandomInt(100, 999);
            const dividend = divisor * quotient + getRandomInt(0, divisor - 1);
            return `<div class="font-mono text-xl flex items-center"><span class="mr-2">${divisor}</span><span class="long-division px-2">${dividend}</span></div>`;
        }
        function generatePlaceValue(idx) {
            const num = getRandomInt(10000, 999999);
            const numStr = num.toString();
            const places = ["ones", "tens", "hundreds", "thousands", "ten thousands", "hundred thousands"];
            const targetPos = getRandomInt(0, numStr.length - 1);
            const placeName = places[numStr.length - 1 - targetPos];
            const formatted = num.toLocaleString();
            if (Math.random() > 0.5) {
                return `<div class="text-base">What is the value of the digit <strong>${numStr[targetPos]}</strong> in <strong>${formatted}</strong>?<div class="mt-4 border-b border-gray-300 w-32 h-6"></div></div>`;
            } else {
                 return `<div class="text-base">Round <strong>${formatted}</strong> to the nearest <strong>${placeName}</strong>.<div class="mt-4 border-b border-gray-300 w-32 h-6"></div></div>`;
            }
        }
        function generateFractions(idx) {
            const num = getRandomInt(1, 9);
            const den = getRandomInt(num + 1, 12);
            const whole = getRandomInt(1, 5);
            return `<div class="text-base">Convert mixed to improper:<div class="mt-2 text-xl font-mono flex items-center gap-2"><span>${whole}</span><div class="fraction"><span class="fraction-top">${num}</span><span class="fraction-bottom">${den}</span></div><span class="mx-2">=</span><div class="fraction"><span class="fraction-top w-8 h-6 bg-gray-100 border border-gray-300"></span><span class="fraction-bottom w-8 h-6 bg-gray-100 border border-gray-300"></span></div></div></div>`;
        }
        function generateAreaPerimeter(idx) {
            const w = getRandomInt(3, 15);
            const h = getRandomInt(3, 15);
            const isArea = Math.random() > 0.5;
            return `<div class="text-base">Find the <strong>${isArea ? 'Area' : 'Perimeter'}</strong>:<div class="mt-2 flex items-center justify-center relative w-32 h-24 border-2 border-current bg-transparent mx-auto"><span class="absolute -top-6 left-1/2 -translate-x-1/2 text-sm">${w} ft</span><span class="absolute -right-8 top-1/2 -translate-y-1/2 text-sm">${h} ft</span></div><div class="mt-4 text-center">Ans: <span class="inline-block border-b border-gray-400 w-16"></span> ft${isArea ? '²' : ''}</div></div>`;
        }
        function generateGeometryLines(idx) {
            const types = ['Parallel', 'Perpendicular', 'Intersecting'];
            const answer = types[Math.floor(Math.random() * types.length)];
            let svg = '';
            if (answer === 'Parallel') svg = `<line x1="10" y1="10" x2="90" y2="10" stroke="currentColor" stroke-width="2"/><line x1="10" y1="40" x2="90" y2="40" stroke="currentColor" stroke-width="2"/>`;
            else if (answer === 'Perpendicular') svg = `<line x1="50" y1="10" x2="50" y2="90" stroke="currentColor" stroke-width="2"/><line x1="10" y1="50" x2="90" y2="50" stroke="currentColor" stroke-width="2"/><rect x="50" y="50" width="10" height="10" fill="none" stroke="currentColor"/>`;
            else svg = `<line x1="10" y1="10" x2="90" y2="90" stroke="currentColor" stroke-width="2"/><line x1="10" y1="90" x2="90" y2="10" stroke="currentColor" stroke-width="2"/>`;
            return `<div><p class="mb-2 text-sm">Identify the type of lines:</p><svg width="100" height="100" class="mx-auto mb-2 border border-dashed border-gray-300 p-2">${svg}</svg><div class="flex gap-2 justify-center text-xs mt-2"><span class="border border-gray-400 px-1 py-1 rounded">Parallel</span><span class="border border-gray-400 px-1 py-1 rounded">Perpendicular</span></div></div>`;
        }
        function generateSymmetry(idx) {
            const shapes = [{path:"M10,20 h80 v40 h-80 z"},{path:"M20,60 L30,20 h40 l10,40 z"},{path:"M10,60 L40,10 L90,50 z"},{path:"M50,80 C20,60 0,40 20,20 C30,10 40,20 50,30 C60,20 70,10 80,20 C100,40 80,60 50,80 z"}];
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            return `<div class="text-base text-center">Line of symmetry?<svg width="100" height="90" class="mx-auto my-2 stroke-current fill-transparent stroke-2"><path d="${shape.path}" /></svg><div class="flex justify-center gap-4 mt-2 font-bold"><div class="flex items-center gap-1"><div class="w-4 h-4 border border-gray-400 rounded-full"></div> Yes</div><div class="flex items-center gap-1"><div class="w-4 h-4 border border-gray-400 rounded-full"></div> No</div></div></div>`;
        }

        // Initialize with default standard
        window.onload = function() {
            setTheme('normal');
            generateWorksheet();
        };

    </script>
</body>
</html>
